name: Publish to NPM

on:
  push:
    branches: [main, master, dev]
  pull_request:
    branches: [main, master, dev]
    types: [opened, synchronize, closed]
  workflow_dispatch:
    inputs:
      force_publish:
        description: 'Force publish even if version unchanged'
        required: false
        default: 'false'
        type: boolean

jobs:
  debug-info:
    runs-on: ubuntu-latest
    steps:
      - name: Debug GitHub Context
        run: |
          echo "Event name: ${{ github.event_name }}"
          echo "Ref: ${{ github.ref }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Base ref: ${{ github.base_ref }}"
          echo "Head ref: ${{ github.head_ref }}"
          echo "PR merged: ${{ github.event.pull_request.merged }}"
          echo "PR action: ${{ github.event.action }}"
          echo "Repository: ${{ github.repository }}"
          echo "Actor: ${{ github.actor }}"
          echo "SHA: ${{ github.sha }}"

  check-version:
    runs-on: ubuntu-latest
    outputs:
      version-changed: ${{ steps.version-check.outputs.changed }}
      new-version: ${{ steps.version-check.outputs.version }}
      should-publish: ${{ steps.version-check.outputs.should_publish }}
      target-branch: ${{ steps.version-check.outputs.target_branch }}
      package-name: ${{ steps.version-check.outputs.package_name }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Check if version changed and determine publish strategy
        id: version-check
        run: |
          # Get current version and base package name
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          BASE_PACKAGE_NAME=$(node -p "require('./package.json').name")
          echo "ğŸ“¦ Current version: $CURRENT_VERSION"
          echo "ğŸ“¦ Base package name: $BASE_PACKAGE_NAME"
          
          # Initialize variables
          VERSION_CHANGED="false"
          SHOULD_PUBLISH="false"
          TARGET_BRANCH=""
          PACKAGE_NAME=""
          
          # Determine target branch and package name
          if [ "${{ github.event_name }}" = "push" ]; then
            case "${{ github.ref }}" in
              "refs/heads/main"|"refs/heads/master")
                TARGET_BRANCH="main"
                PACKAGE_NAME="$BASE_PACKAGE_NAME"
                echo "ğŸ¯ Target: Main branch push (NO PUBLISH - only on PR merge)"
                ;;
              "refs/heads/dev")
                TARGET_BRANCH="dev"
                PACKAGE_NAME="${BASE_PACKAGE_NAME}-dev"
                echo "ğŸ¯ Target: Dev branch push (dev package)"
                ;;
              *)
                echo "âŒ Unsupported branch: ${{ github.ref }}"
                ;;
            esac
          elif [ "${{ github.event_name }}" = "pull_request" ]; then
            case "${{ github.base_ref }}" in
              "main"|"master")
                TARGET_BRANCH="main"
                PACKAGE_NAME="$BASE_PACKAGE_NAME"
                if [ "${{ github.event.action }}" = "closed" ] && [ "${{ github.event.pull_request.merged }}" = "true" ]; then
                  echo "ğŸ¯ Target: PR merged to main (production package)"
                else
                  echo "ğŸ¯ Target: PR to main (NO PUBLISH - only on merge)"
                fi
                ;;
              "dev")
                TARGET_BRANCH="dev"
                PACKAGE_NAME="${BASE_PACKAGE_NAME}-dev"
                echo "ğŸ¯ Target: PR to dev (dev package)"
                ;;
              *)
                echo "âŒ Unsupported base branch: ${{ github.base_ref }}"
                ;;
            esac
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TARGET_BRANCH="manual"
            PACKAGE_NAME="$BASE_PACKAGE_NAME"
            echo "ğŸ¯ Target: Manual trigger"
          fi
          
          # Check for manual force publish
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ github.event.inputs.force_publish }}" = "true" ]; then
            echo "ğŸ”§ Manual force publish triggered"
            VERSION_CHANGED="true"
            SHOULD_PUBLISH="true"
          else
            # Check if we can compare with previous commit
            if git show HEAD~1:package.json > /tmp/prev_package.json 2>/dev/null; then
              PREVIOUS_VERSION=$(node -p "JSON.parse(require('fs').readFileSync('/tmp/prev_package.json', 'utf8')).version")
              echo "ğŸ“¦ Previous version: $PREVIOUS_VERSION"
              
              if [ "$CURRENT_VERSION" != "$PREVIOUS_VERSION" ]; then
                echo "âœ… Version changed: $PREVIOUS_VERSION â†’ $CURRENT_VERSION"
                VERSION_CHANGED="true"
              else
                echo "âŒ Version unchanged: $CURRENT_VERSION"
                VERSION_CHANGED="false"
              fi
            else
              echo "ğŸ†• No previous version found (first commit or new file)"
              VERSION_CHANGED="true"
            fi
            
            # Determine if we should publish based on branch-specific rules
            if [ "$VERSION_CHANGED" = "true" ] && [ -n "$TARGET_BRANCH" ]; then
              if [ "$TARGET_BRANCH" = "main" ]; then
                # Main branch: Only publish when PR is merged
                if [ "${{ github.event_name }}" = "pull_request" ] && [ "${{ github.event.action }}" = "closed" ] && [ "${{ github.event.pull_request.merged }}" = "true" ]; then
                  echo "âœ… Main branch: PR merged detected"
                  SHOULD_PUBLISH="true"
                else
                  echo "âŒ Main branch: Only merged PRs allowed, got event=${{ github.event_name }}, action=${{ github.event.action }}, merged=${{ github.event.pull_request.merged }}"
                  SHOULD_PUBLISH="false"
                fi
              elif [ "$TARGET_BRANCH" = "dev" ]; then
                # Dev branch: Publish on both push and PR (but not on PR close unless merged)
                if [ "${{ github.event_name }}" = "push" ]; then
                  echo "âœ… Dev branch: Direct push detected"
                  SHOULD_PUBLISH="true"
                elif [ "${{ github.event_name }}" = "pull_request" ]; then
                  if [ "${{ github.event.action }}" = "closed" ]; then
                    if [ "${{ github.event.pull_request.merged }}" = "true" ]; then
                      echo "âœ… Dev branch: PR merged detected"
                      SHOULD_PUBLISH="true"
                    else
                      echo "âŒ Dev branch: PR closed but not merged"
                      SHOULD_PUBLISH="false"
                    fi
                  else
                    echo "âœ… Dev branch: PR opened/updated"
                    SHOULD_PUBLISH="true"
                  fi
                else
                  echo "âŒ Dev branch: Unexpected event ${{ github.event_name }}"
                  SHOULD_PUBLISH="false"
                fi
              fi
            else
              echo "âŒ Publishing conditions not met"
              SHOULD_PUBLISH="false"
            fi
          fi
          
          # Set outputs
          echo "changed=$VERSION_CHANGED" >> $GITHUB_OUTPUT
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "should_publish=$SHOULD_PUBLISH" >> $GITHUB_OUTPUT
          echo "target_branch=$TARGET_BRANCH" >> $GITHUB_OUTPUT
          echo "package_name=$PACKAGE_NAME" >> $GITHUB_OUTPUT
          
          # Final summary
          echo "ğŸ¯ Final decision:"
          echo "   Version changed: $VERSION_CHANGED"
          echo "   Should publish: $SHOULD_PUBLISH"
          echo "   Target branch: $TARGET_BRANCH"
          echo "   Package name: $PACKAGE_NAME"
          echo "   Event: ${{ github.event_name }}"
          echo "   Action: ${{ github.event.action }}"
          echo "   Merged: ${{ github.event.pull_request.merged }}"

  test:
    runs-on: ubuntu-latest
    # Skip tests on PR close events that aren't merges
    if: |
      !(github.event_name == 'pull_request' && 
        github.event.action == 'closed' && 
        github.event.pull_request.merged != true)
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run build
        run: npm run build

      - name: Run tests (if any)
        run: npm test --if-present

      - name: Check TypeScript compilation
        run: npx tsc --noEmit

  publish:
    needs: [check-version, test, debug-info]
    runs-on: ubuntu-latest
    if: needs.check-version.outputs.should-publish == 'true'
    steps:
      - name: ğŸš€ Publishing to NPM
        run: |
          echo "ğŸ‰ All conditions met - proceeding with publish!"
          echo "Package name: ${{ needs.check-version.outputs.package-name }}"
          echo "Version: ${{ needs.check-version.outputs.new-version }}"
          echo "Target branch: ${{ needs.check-version.outputs.target-branch }}"
          echo "Event: ${{ github.event_name }}"
          echo "Action: ${{ github.event.action }}"

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          registry-url: 'https://registry.npmjs.org'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Update package name for dev builds
        if: needs.check-version.outputs.target-branch == 'dev'
        run: |
          echo "ğŸ“ Updating package name to: ${{ needs.check-version.outputs.package-name }}"
          node -e "
            const pkg = require('./package.json');
            pkg.name = '${{ needs.check-version.outputs.package-name }}';
            require('fs').writeFileSync('./package.json', JSON.stringify(pkg, null, 2));
          "

      - name: Verify package contents
        run: |
          echo "ğŸ“¦ Package contents that will be published:"
          npm pack --dry-run
          echo ""
          echo "ğŸ“‹ Final package.json name:"
          node -p "require('./package.json').name"

      - name: Check NPM authentication
        run: |
          echo "ğŸ” Checking NPM authentication..."
          if [ -z "$NODE_AUTH_TOKEN" ]; then
            echo "âŒ NODE_AUTH_TOKEN is not set"
            exit 1
          else
            echo "âœ… NODE_AUTH_TOKEN is set"
            echo "Token length: ${#NODE_AUTH_TOKEN}"
          fi
          
          # Check if we can authenticate
          npm whoami || echo "âŒ NPM authentication failed"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Configure NPM authentication
        run: |
          echo "ğŸ”§ Configuring NPM authentication..."
          echo "//registry.npmjs.org/:_authToken=$NODE_AUTH_TOKEN" > ~/.npmrc
          echo "registry=https://registry.npmjs.org/" >> ~/.npmrc
          echo "always-auth=true" >> ~/.npmrc
          
          # Verify authentication
          npm whoami
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish to NPM
        run: |
          echo "ğŸš€ Publishing ${{ needs.check-version.outputs.package-name }}@${{ needs.check-version.outputs.new-version }} to NPM..."
          npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ needs.check-version.outputs.new-version }}-${{ needs.check-version.outputs.target-branch }}
          release_name: ${{ needs.check-version.outputs.target-branch == 'dev' && 'Dev Release' || 'Production Release' }} v${{ needs.check-version.outputs.new-version }}
          body: |
            ## ğŸ‰ ${{ needs.check-version.outputs.target-branch == 'dev' && 'Dev Release' || 'Production Release' }}: v${{ needs.check-version.outputs.new-version }}
            
            **Package**: `${{ needs.check-version.outputs.package-name }}`
            **Branch**: `${{ needs.check-version.outputs.target-branch }}`
            **Trigger**: ${{ github.event_name == 'pull_request' && github.event.action == 'closed' && 'PR Merge' || github.event_name }}
            
            ### ğŸ“¦ Installation
            ```bash
            npm install ${{ needs.check-version.outputs.package-name }}@${{ needs.check-version.outputs.new-version }}
            ```
            
            ### ğŸ“‹ Changes
            See [CHANGELOG.md](CHANGELOG.md) for detailed changes.
          draft: false
          prerelease: ${{ needs.check-version.outputs.target-branch == 'dev' }}

  publish-skipped:
    needs: [check-version, debug-info]
    runs-on: ubuntu-latest
    if: needs.check-version.outputs.should-publish != 'true'
    steps:
      - name: â­ï¸ Publish Skipped
        run: |
          echo "âŒ Publish was skipped. Reasons:"
          echo "   Version changed: ${{ needs.check-version.outputs.version-changed }}"
          echo "   Should publish: ${{ needs.check-version.outputs.should-publish }}"
          echo "   Target branch: ${{ needs.check-version.outputs.target-branch }}"
          echo "   Event type: ${{ github.event_name }}"
          echo "   Event action: ${{ github.event.action }}"
          echo "   PR merged: ${{ github.event.pull_request.merged }}"
          echo "   Package name: ${{ needs.check-version.outputs.package-name }}"
          echo ""
          echo "ğŸ’¡ Publishing rules:"
          echo "   ğŸ“¦ Dev branch: Publishes on PR open/update/merge and push as 'dynatrace-mcp-server-dev'"
          echo "   ğŸ“¦ Main branch: ONLY publishes when PR is approved and merged as 'dynatrace-mcp-server'"